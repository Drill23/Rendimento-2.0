<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGRA v5.3 - Análise de Rendimento</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Bibliotecas JS (CDNs) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { /* Cores e variáveis */
            --bs-primary-rgb: 0, 86, 179;
            --bs-secondary-rgb: 108, 117, 125;
            --bs-light-rgb: 248, 249, 250;
            --bs-dark-rgb: 33, 37, 41; /* Dark mais escuro */
        }
        body { padding-top: 70px; background-color: #f8f9fa; /* Fundo geral */ }
        .navbar { background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .navbar-brand { color: #0056b3; font-weight: 600; }
        .status-chart-container { width: 180px; height: 90px; }
        .form-label { font-weight: 500; color: #495057; margin-bottom: 0.3rem; font-size: 0.9rem; }
        .btn-action-icon { padding: 0.25rem 0.5rem; font-size: 0.8rem; line-height: 1; margin: 0 1px; }
        .toast-container { z-index: 1090; }
        .comparative-chart-container { min-height: 380px; position: relative; padding: 1.25rem; background-color: #fff; border: 1px solid #dee2e6; border-radius: 0.375rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .analysis-details-box { background-color: #fff; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1.5rem; height: 100%; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .analysis-details-box h4 { color: var(--bs-primary); border-bottom: 2px solid rgba(var(--bs-primary-rgb), 0.3); padding-bottom: 0.6rem; margin-bottom: 1.2rem; font-weight: 600;}
        .analysis-details-box .detail-label { font-weight: 600; color: #343a40; }
        .analysis-details-box p { line-height: 1.7; }
        .accordion-button:not(.collapsed) { color: var(--bs-primary); background-color: rgba(var(--bs-primary-rgb), 0.08); box-shadow: inset 0 -1px 0 rgba(0,0,0,.1); }
        .accordion-button:focus { box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25); }
        canvas { display: block; width: 100% !important; height: auto !important; }
        #statusPieChart { max-height: 90px; }
        #comparativeBarChart { max-height: 340px; }
        .card { margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,.125); box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .card-header { background-color: rgba(var(--bs-light-rgb), 0.7); border-bottom: 1px solid rgba(0,0,0,.125); }
        .nav-tabs .nav-link { color: var(--bs-secondary); font-weight: 500; }
        .nav-tabs .nav-link.active { color: var(--bs-primary); border-color: #dee2e6 #dee2e6 var(--bs-primary); border-bottom-width: 3px; background-color: #fff; }
        .nav-tabs { border-bottom: 1px solid #dee2e6; }
        .btn .fas, .btn .far, .btn .fab { margin-right: 0.5em; }
        .sticky-top { z-index: 1010; }
        .badge.bg-meta-ok { background-color: #d1e7dd !important; color: #0f5132 !important; border: 1px solid #a3cfbb !important; }
        .badge.bg-meta-nok { background-color: #f8d7da !important; color: #842029 !important; border: 1px solid #f5c2c7 !important; }

        /* --- ESTILOS MELHORADOS PARA TABELA --- */
        .table-container {
            max-height: 70vh; /* Aumenta altura máxima */
            overflow: auto; /* Garante ambas rolagens */
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #fff;
        }
        #tabelaAcoes {
             font-size: 0.9rem; /* Tamanho base da fonte */
             margin-bottom: 0; /* Remove margem inferior padrão da tabela */
        }
        #tabelaAcoes thead th {
            background-color: #343a40; /* Header escuro */
            color: #fff;
            font-weight: 600;
            vertical-align: middle;
            white-space: nowrap;
            padding: 0.75rem 0.85rem; /* Padding do cabeçalho */
            position: sticky; /* Faz o cabeçalho grudar */
            top: 0;           /* No topo do container */
            z-index: 1;       /* Garante que fique acima do conteúdo */
        }
        #tabelaAcoes tbody td {
            vertical-align: middle;
            padding: 0.65rem 0.85rem; /* Padding das células */
            border-color: #e9ecef; /* Bordas mais suaves */
        }
        #tabelaAcoes tbody tr:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.05); /* Hover suave azulado */
        }
        #tabelaAcoes .text-end { text-align: right !important; }
        #tabelaAcoes .text-center { text-align: center !important; }
        #tabelaAcoes td:nth-child(9) { /* Coluna Ação Corretiva */
             white-space: normal; /* Permite quebra */
             min-width: 180px;   /* Largura mínima */
             max-width: 250px;   /* Largura máxima */
             overflow: hidden;
             text-overflow: ellipsis; /* Adiciona "..." se estourar max-width (raro com normal) */
        }
         /* Outras colunas não quebram linha */
        #tabelaAcoes td:not(:nth-child(9)) { white-space: nowrap; }
        /* Remove table-sm se estava presente, remove table-bordered se desejar linhas mais limpas */
        /* Ex: class="table table-striped table-hover align-middle" */

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand fs-5" href="#"> <i class="fas fa-cogs text-primary me-2"></i>SIGRA </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0"></ul>
            <div class="status-chart-container d-flex align-items-center"><canvas id="statusPieChart"></canvas></div>
        </div>
      </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
        <div id="migrationStatus" class="alert alert-info alert-dismissible fade show d-none" role="alert"> <i class="fas fa-info-circle me-2"></i> <span id="migrationText"></span> <button type="button" class="btn-close" data-bs-dismiss="alert"></button> </div>

        <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation"> <button class="nav-link active" id="entry-tab" data-bs-toggle="tab" data-bs-target="#entry-tab-pane" type="button"><i class="fas fa-edit"></i> Entrada/Edição</button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-tab-pane" type="button"><i class="fas fa-chart-line"></i> Análise</button> </li>
            <li class="nav-item" role="presentation"> <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-tab-pane" type="button"><i class="fas fa-table"></i> Dados</button> </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- ABA 1: Entrada / Edição -->
            <div class="tab-pane fade show active" id="entry-tab-pane" role="tabpanel" tabindex="0">
                <div class="card">
                    <div class="card-header bg-light border-bottom pt-3 pb-2"><h2 class="h5 mb-0 text-primary fw-semibold"><i class="fas fa-file-alt me-2"></i><span id="formTitle">Inserir Novo Registro</span></h2></div>
                    <div class="card-body p-4">
                        <input type="hidden" id="editKeyInput">
                        <h3 class="h6 text-secondary mb-3 fw-bold">Dados Principais</h3>
                        <div class="row g-3 mb-4">
                             <div class="col-md-4"> <label for="dataRegistro" class="form-label">Data do Registro*</label> <input type="date" class="form-control form-control-sm" id="dataRegistro" required /> </div>
                             <div class="col-md-4"> <label for="referenceMonthInput" class="form-label">Mês de Referência*</label> <select class="form-select form-select-sm" id="referenceMonthInput" required></select> </div>
                             <div class="col-md-4"> <label for="itemSelect" class="form-label">Item Analisado*</label> <select class="form-select form-select-sm" id="itemSelect" required></select> </div>
                        </div>
                        <div class="row g-3 mb-4">
                             <div class="col-md-3"> <label for="percRealizado" class="form-label">Rend. Realizado (%)</label> <input type="number" step="0.001" class="form-control form-control-sm" id="percRealizado" placeholder="Ex: 26,500" min="0" /> </div>
                             <div class="col-md-3"> <label for="toneladaAbatida" class="form-label">Abate Total (Kg)</label> <input type="number" step="1" class="form-control form-control-sm" id="toneladaAbatida" placeholder="Ex: 3790648" min="0" /> </div>
                             <div class="col-md-3"> <label for="origemInput" class="form-label">Origem Ação/Obs.*</label> <input type="text" class="form-control form-control-sm" id="origemInput" placeholder="Ex: Auditoria..." required> </div>
                             <div class="col-md-3"> <label for="setorInput" class="form-label">Setor Ação*</label> <input type="text" class="form-control form-control-sm" id="setorInput" placeholder="Ex: Produção..." required> </div>
                        </div>
                        <h3 class="h6 text-secondary mb-3 fw-bold">Plano de Ação (Opcional)</h3>
                        <div class="accordion" id="actionDetailsAccordion">
                            <div class="accordion-item border rounded-3 mb-3">
                                <h2 class="accordion-header"> <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"><i class="fas fa-tasks me-2"></i> Detalhes da Ação Corretiva</button> </h2>
                                <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#actionDetailsAccordion">
                                    <div class="accordion-body bg-light p-4">
                                        <div class="row g-3 mb-3"> <div class="col-md-12"> <label for="acaoInput" class="form-label">Descrição da Ação</label> <textarea class="form-control form-control-sm" id="acaoInput" rows="3" placeholder="Detalhar a ação a ser tomada..."></textarea> </div> </div>
                                        <div class="row g-3"> <div class="col-md-3"> <label for="dataPrevista" class="form-label">Data Prevista</label> <input type="date" class="form-control form-control-sm" id="dataPrevista" /> </div> <div class="col-md-3"> <label for="dataRealizada" class="form-label">Data Realizada</label> <input type="date" class="form-control form-control-sm" id="dataRealizada" /> </div> <div class="col-md-3"> <label for="areaResponsavel" class="form-label">Área Responsável</label> <input type="text" class="form-control form-control-sm" id="areaResponsavel" placeholder="Ex: Supervisão..." /> </div> <div class="col-md-3"> <label for="responsavelNome" class="form-label">Responsável</label> <input type="text" class="form-control form-control-sm" id="responsavelNome" placeholder="Ex: João Silva..." /> </div> </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-2 mt-4">
                            <button type="button" id="btnSalvar" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Salvar / Atualizar</button>
                            <button type="button" id="btnCancelarEdicao" class="btn btn-secondary btn-sm d-none"><i class="fas fa-times"></i> Cancelar Edição</button>
                            <button type="button" id="btnUndo" class="btn btn-warning btn-sm" disabled><i class="fas fa-undo"></i> Desfazer</button>
                        </div>
                        <p class="form-text text-muted mt-2"><small>* Campos obrigatórios.</small></p>
                    </div>
                </div>
            </div>

            <!-- ABA 2: Análise Comparativa -->
            <div class="tab-pane fade" id="analysis-tab-pane" role="tabpanel" tabindex="0">
                 <div class="card">
                     <div class="card-header bg-light border-bottom pt-3 pb-2"><h2 class="h5 mb-0 text-primary fw-semibold"><i class="fas fa-chart-bar me-2"></i>Análise Comparativa por Item</h2></div>
                     <div class="card-body p-4">
                         <div class="row g-3 align-items-end mb-4 filter-container bg-light p-3 rounded border">
                             <div class="col-md-5 col-lg-4"> <label for="itemAnaliseSelect" class="form-label">Selecionar Item:</label> <select class="form-select form-select-sm" id="itemAnaliseSelect"></select> </div>
                             <div class="col-md-auto"> <button type="button" id="btnGerarAnalise" class="btn btn-success btn-sm"><i class="fas fa-sync-alt"></i> Gerar Análise</button> </div>
                             <div class="col-md-auto ms-auto"> <button type="button" id="btnExportarPDF" class="btn btn-danger btn-sm d-none"><i class="fas fa-file-pdf"></i> Exportar Relatório PDF</button> </div>
                         </div>
                          <p id="analiseStatus" class="text-info fw-bold mb-3"></p>
                          <div id="analysisResults" class="d-none">
                             <hr class="my-4">
                             <div class="row g-4">
                                 <div class="col-lg-5 d-flex"> <div id="comparisonDetailsOutput" class="analysis-details-box w-100"> <h4 class="text-center text-muted fst-italic">...</h4> </div> </div>
                                 <div class="col-lg-7"> <div class="comparative-chart-container"> <canvas id="comparativeBarChart"></canvas> </div> </div>
                             </div>
                             <p id="pdfStatus" class="mt-3 fw-bold text-muted small"></p>
                          </div>
                     </div>
                 </div>
            </div>

            <!-- ABA 3: Dados Detalhados -->
            <div class="tab-pane fade" id="data-tab-pane" role="tabpanel" tabindex="0">
                <div class="card">
                     <div class="card-header bg-light border-bottom pt-3 pb-2"><h2 class="h5 mb-0 text-primary fw-semibold"><i class="fas fa-database me-2"></i>Dados Detalhados e Plano de Ações</h2></div>
                     <div class="card-body p-4">
                        <div class="p-3 mb-4 bg-light border rounded filter-container">
                             <div class="row g-3 align-items-center">
                                <div class="col-md-3"> <label for="filterMonth" class="form-label">Mês Ref. (Mmm/AA):</label> <input type="text" class="form-control form-control-sm" id="filterMonth" placeholder="Ex: Jan/24"> </div>
                                <div class="col-md-3"> <label for="filterItem" class="form-label">Item:</label> <input type="text" class="form-control form-control-sm" id="filterItem" placeholder="Ex: Filé"> </div>
                                <div class="col-md-3"> <label for="filterStatus" class="form-label">Status Ação:</label> <select class="form-select form-select-sm" id="filterStatus"> <option value="">Todos</option> <option value="Pendente">Pendente</option> <option value="Realizado">Realizado</option> <option value="Não Realizado">Não Realizado</option> </select> </div>
                                <div class="col-md-3 d-flex justify-content-end align-items-end pt-3">
                                    <button type="button" id="btnClearFilters" class="btn btn-sm btn-outline-secondary me-2" title="Limpar Filtros"><i class="fas fa-eraser"></i> Limpar</button>
                                    <button type="button" id="btnExportCSV" class="btn btn-sm btn-success" title="Exportar para CSV"><i class="fas fa-file-csv"></i> CSV</button>
                                    <!-- NOVO: Botões de Exportação e Importação JSON -->
                                    <button type="button" id="btnExportJSON" class="btn btn-sm btn-info ms-2" title="Exportar para JSON"><i class="fas fa-file-export"></i> JSON Export</button>
                                    <button type="button" id="btnImportJSON" class="btn btn-sm btn-warning ms-2" title="Importar do JSON"><i class="fas fa-file-import"></i> JSON Import</button>
                                </div>
                             </div>
                        </div>
                         <div class="table-container shadow-sm"> <!-- Container com rolagem -->
                             <table class="table table-striped table-hover align-middle" id="tabelaAcoes"> <!-- Removido table-sm e table-bordered -->
                                 <thead class="sticky-top"> <!-- Cabeçalho fixo -->
                                     <tr>
                                         <th class="text-center">Data Reg.</th> <th class="text-center">Mês Ref.</th> <th>Item</th> <th class="text-end">Real.(%)</th> <th class="text-end">Déficit (Kg)</th> <th class="text-end">Caixas Falt.</th> <th>Origem</th> <th>Setor</th> <th>Ação Corretiva</th> <th class="text-center">Data Prev.</th> <th class="text-center">Data Real.</th> <th class="text-center">Status Ação</th> <th>Área Resp.</th> <th>Responsável</th> <th class="text-center">Opções</th>
                                     </tr>
                                 </thead>
                                 <tbody> <tr><td colspan="15" class="text-center p-5 text-muted fst-italic">Carregando dados...</td></tr> </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
            </div>
        </div> <!-- Fim Tab Content -->
    </div> <!-- Fim Container -->

    <!-- Input oculto para Importação de JSON -->
    <!-- NOVO: Input de arquivo para importar os dados JSON -->
    <input type="file" id="inputImportJson" accept=".json" style="display: none;">

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
    //<![CDATA[
    /***********************************************************
     * CONFIGURAÇÕES / CONSTANTES / VARIÁVEIS GLOBAIS
     ***********************************************************/
    const currentLocalStorageKey = "sigraData_v5.3"; // Chave atualizada
    const previousLocalStorageKeys = ["sigraData_v5.2", "sigraData_v5.1", "planoAcoesRendimentoData_v5_Bootstrap", "planoAcoesRendimentoData_v4", "planoAcoesRendimentoData_v3"];
    const metas = { "Coxa e Sobrecoxa": 26.500, "Filé": 26.500, "Coxinha da Asa": 4.600, "Meio da Asa": 2.800, "Ponta da Asa": 20, "Fígado": 1.600, "Moela": 1.100, "Coração": 0.480, "Pés": 2.850, "CMS": 15.000, "Sambiquira": 0.800, "Rendimento Industrial": 81.600 };
    // ---> ALTERAÇÃO SOLICITADA AQUI <--- Adicionado Ponta da Asa: 20
    const boxWeights = { "Coxa e Sobrecoxa": 20, "Filé": 20, "Coxinha da Asa": 20, "Meio da Asa": 20, "Ponta da Asa": 20, "Fígado": 20, "Moela": 20, "Coração": 20, "Pés": 16, "CMS": 20, "Sambiquira": 20 };
    // ---> FIM DA ALTERAÇÃO SOLICITADA <---
    const itensDisponiveis = Object.keys(metas).sort();
    const monthNamesShort = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
    let storedData = {}, editMode = false, previousStoredDataState = null, toastCounter = 0;
    let statusPieChart = null, comparativeBarChart = null;
    // Referências DOM (mantidas)
    const formTitle = document.getElementById("formTitle"), editKeyInput = document.getElementById("editKeyInput"), dataRegistroInput = document.getElementById("dataRegistro"), referenceMonthInput = document.getElementById("referenceMonthInput"), itemSelect = document.getElementById("itemSelect"), percRealizadoInput = document.getElementById("percRealizado"), toneladaAbatidaInput = document.getElementById("toneladaAbatida"), origemInput = document.getElementById("origemInput"), setorInput = document.getElementById("setorInput"), acaoInput = document.getElementById("acaoInput"), dataPrevistaInput = document.getElementById("dataPrevista"), dataRealizadaInput = document.getElementById("dataRealizada"), areaResponsavelInput = document.getElementById("areaResponsavel"), responsavelNomeInput = document.getElementById("responsavelNome"), btnSalvar = document.getElementById("btnSalvar"), btnCancelarEdicao = document.getElementById("btnCancelarEdicao"), btnUndo = document.getElementById("btnUndo"), tabelaAcoesBody = document.querySelector("#tabelaAcoes tbody"), itemAnaliseSelect = document.getElementById("itemAnaliseSelect"), btnGerarAnalise = document.getElementById("btnGerarAnalise"), btnExportarPDF = document.getElementById("btnExportarPDF"), analysisResultsDiv = document.getElementById("analysisResults"), comparisonDetailsOutputDiv = document.getElementById("comparisonDetailsOutput"), comparativeChartCanvas = document.getElementById("comparativeBarChart"), analiseStatusSpan = document.getElementById("analiseStatus"), pdfStatusSpan = document.getElementById("pdfStatus"), migrationStatusDiv = document.getElementById("migrationStatus"), migrationText = document.getElementById("migrationText"), toastContainer = document.querySelector('.toast-container');
    const filterMonthInput = document.getElementById("filterMonth"), filterItemInput = document.getElementById("filterItem"), filterStatusSelect = document.getElementById("filterStatus"), btnClearFilters = document.getElementById("btnClearFilters"), btnExportCSV = document.getElementById("btnExportCSV");
    // NOVO: Referências para JSON Import/Export
    const btnExportJSON = document.getElementById("btnExportJSON"), btnImportJSON = document.getElementById("btnImportJSON"), inputImportJson = document.getElementById("inputImportJson");

    /***********************************************************
     * FUNÇÕES DE UTILIDADE (showToast atualizada)
     ***********************************************************/
    function generateUniqueKey() { return `ID_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`; }
    function formatStatus(status) { status = status || "Pendente"; let cl = 'bg-warning text-dark'; if (status === 'Realizado') cl = 'bg-success text-white'; else if (status === 'Não Realizado') cl = 'bg-danger text-white'; const loc = status === "Nao Realizado" ? "Não Realizado" : status; return `<span class="badge rounded-pill ${cl} px-2 py-1">${loc}</span>`; }
    function formatDate(dStr) { if (!dStr) return "---"; try { const [y, m, d] = dStr.split('-'); return `${d}/${m}/${y}`; } catch (e) { return dStr; } }
    function formatYearMonth(ym) { if (!ym || ym.length !== 7) return "---"; try { const [y, m] = ym.split('-'); return `${monthNamesShort[parseInt(m, 10) - 1]}/${y.substring(2)}`; } catch (e) { return "Inv."; }}
    function calcularDeficitKg(item, perc, ton) { const m = metas[item]; if (m === undefined || perc === null || ton === null || perc >= m) return null; const diff = m - perc; const miss = (diff / 100) * ton; return miss > 0 ? miss : null; }
    function calcularMissingBoxes(item, deficit) { if (deficit === null || deficit <= 0) return null; const w = boxWeights[item]; return w ? deficit / w : null; }
    function formatDeficitForTable(def) { return def ? `≈ ${def.toFixed(0)} kg` : "---"; }
    function formatBoxesForTable(box) { return box ? `${box.toFixed(1)} cx` : "---"; }
    function deepCopy(obj) { try { return JSON.parse(JSON.stringify(obj)); } catch(e) { console.error("Erro cópia:", e); return {}; }}
    function showToast(message, isError = false, duration = 4000) { toastCounter++; const toastId = `toast-${toastCounter}`; const toastIcon = isError ? '<i class="fas fa-exclamation-triangle me-2"></i>' : '<i class="fas fa-check-circle me-2"></i>'; const toastBg = isError ? 'bg-danger' : 'bg-success'; const toastHtml = `<div id="${toastId}" class="toast align-items-center text-white ${toastBg} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${toastIcon}${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`; toastContainer.insertAdjacentHTML('beforeend', toastHtml); const toastElement = document.getElementById(toastId); const toast = new bootstrap.Toast(toastElement, { delay: duration }); toast.show(); toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove()); }

    /***********************************************************
     * INICIALIZAÇÃO E MIGRAÇÃO (mantida)
     ***********************************************************/
     function populateSelect(el, opts, def=true) { el.innerHTML = def ? "<option value=''>Selecione...</option>" : ""; opts.forEach(i => el.appendChild(new Option(i, i))); }
     function populateRefMonth() { referenceMonthInput.innerHTML = '<option value="">Selecione...</option>'; const t = new Date(), cy = t.getFullYear(), yrs = [cy + 1, cy, cy - 1, cy - 2]; yrs.forEach(y => { for (let m = 11; m >= 0; m--) { const v = `${y}-${String(m + 1).padStart(2, '0')}`, txt = `${monthNamesShort[m]}/${String(y).substring(2)}`; referenceMonthInput.appendChild(new Option(txt, v)); } }); referenceMonthInput.value = getCurrentRefMonth(); }
     function getCurrentRefMonth() { const t = new Date(); return `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}`; }
     function loadFromLocalStorage() { let loaded = false, migrated = false, from = ''; const current = localStorage.getItem(currentLocalStorageKey); if (current) { try { storedData = JSON.parse(current); loaded = true; } catch (e) { console.error(`Erro ${currentLocalStorageKey}:`, e); storedData = {}; } } if (!loaded) { for (const oldKey of previousLocalStorageKeys) { const old = localStorage.getItem(oldKey); if (old) { from = oldKey; try { storedData = migrateOldData(JSON.parse(old)); saveToLocalStorage(); localStorage.removeItem(oldKey); loaded = true; migrated = true; break; } catch (e) { console.error(`Erro migração ${oldKey}:`, e); storedData = {}; break; } } } } if (!loaded) storedData = {}; renderTable(); updateStatusChart(); filterTable(); if (migrated) { migrationText.textContent = `Dados da versão (${from}) carregados e atualizados!`; migrationStatusDiv.classList.remove('d-none'); } }
     function migrateOldData(oldData) { const newData={}; for (const k in oldData) { if (oldData.hasOwnProperty(k)) { const o = oldData[k], n = { ...o }; n.referenceMonth = o.referenceMonth || null; n.deficitKg = calcularDeficitKg(o.item, o.percRealizado, o.tonAbatida); n.missingBoxes = calcularMissingBoxes(o.item, n.deficitKg); n.dataRegistro = o.dataRegistro || null; n.item = o.item || null; n.percRealizado = o.percRealizado ?? null; n.toneladaAbatida = o.tonAbatida ?? null; n.origem = o.origem || ''; n.setor = o.setor || ''; n.acao = o.acao || ''; n.dataPrevista = o.dataPrevista || ''; n.dataRealizada = o.dataRealizada || ''; n.statusAcao = o.statusAcao || (o.dataRealizada ? 'Realizado' : 'Pendente'); n.areaResp = o.areaResp || ''; n.respNome = o.respNome || ''; newData[k] = n; } } return newData; }
     function saveToLocalStorage() { try { localStorage.setItem(currentLocalStorageKey, JSON.stringify(storedData)); } catch (e) { console.error("Erro ao salvar no Local Storage:", e); showToast("Erro: Não foi possível salvar os dados. O armazenamento pode estar cheio.", true, 6000); }}
     document.addEventListener("DOMContentLoaded", () => { 
         populateSelect(itemSelect, itensDisponiveis); 
         populateSelect(itemAnaliseSelect, itensDisponiveis); 
         populateRefMonth(); 
         loadFromLocalStorage();

         // --- NOVO: Carregamento automático do arquivo JSON "dados.json" ---
         fetch('dados.json')
           .then(response => {
               if (!response.ok) {
                   throw new Error('Erro na requisição: ' + response.status);
               }
               return response.json();
           })
           .then(data => {
               storedData = data;
               saveToLocalStorage();
               renderTable();
               updateStatusChart();
               filterTable();
               showToast("Dados carregados do JSON com sucesso!", false);
           })
           .catch(error => {
               console.error("Erro ao carregar dados.json:", error);
               showToast("Erro ao carregar dados.json.", true);
           });
         // --- FIM DA ALTERAÇÃO PARA LOAD AUTOMÁTICO DO JSON ---

         setupEventListeners(); 
         Chart.register(chartjsPluginAnnotation); 
         const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]'); 
         const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
     });

    /***********************************************************
     * CRUD E DESFAZER (Lógica de cálculo em salvarDados mantida, pois já estava correta)
     ***********************************************************/
    function savePreviousState() { try { previousStoredDataState = deepCopy(storedData); btnUndo.disabled = false; } catch(e){ console.error("Falha undo state:", e); btnUndo.disabled = true; }}

    function salvarDados() {
        let isValid = true;
        [dataRegistroInput, referenceMonthInput, itemSelect, origemInput, setorInput].forEach(f => {
            f.classList.remove('is-invalid');
            if (!f.value) {
                f.classList.add('is-invalid');
                isValid = false;
            }
        });

        const percInputStr = percRealizadoInput.value.replace(",",".");
        const perc = percInputStr !== "" ? parseFloat(percInputStr) : null;
        percRealizadoInput.classList.remove('is-invalid');
        if (perc !== null && (isNaN(perc) || perc < 0)) {
            percRealizadoInput.classList.add('is-invalid');
            isValid = false;
            showToast("Percentual Realizado inválido ou negativo.", true);
        }

        const tonInputStr = toneladaAbatidaInput.value;
        const ton = tonInputStr !== "" ? parseFloat(tonInputStr) : null;
         toneladaAbatidaInput.classList.remove('is-invalid');
         if (ton !== null && (isNaN(ton) || ton < 0)) {
             toneladaAbatidaInput.classList.add('is-invalid');
             isValid = false;
             showToast("Abate Total (Kg) inválido ou negativo.", true);
         }

        if (!isValid) {
            showToast("Verifique os campos marcados.", true);
            return;
        }

        const editKey = editKeyInput.value;
        const item = itemSelect.value;
        const defKg = calcularDeficitKg(item, perc, ton);
        const missBox = calcularMissingBoxes(item, defKg);
        const dataR = dataRealizadaInput.value;
        let statusA = dataR ? "Realizado" : "Pendente";
        if (editMode && editKey && storedData[editKey] && storedData[editKey].statusAcao === 'Não Realizado' && !dataR) {
            statusA = 'Não Realizado';
        }

        savePreviousState();
        let registro = {
            dataRegistro: dataRegistroInput.value,
            referenceMonth: referenceMonthInput.value,
            item: item,
            percRealizado: perc,
            toneladaAbatida: ton,
            deficitKg: defKg,
            missingBoxes: missBox,
            origem: origemInput.value.trim(),
            setor: setorInput.value.trim(),
            acao: acaoInput.value.trim(),
            dataPrevista: dataPrevistaInput.value,
            dataRealizada: dataR,
            statusAcao: statusA,
            areaResp: areaResponsavelInput.value.trim(),
            respNome: responsavelNomeInput.value.trim()
        };

        const keyToUse = editMode && editKey ? editKey : generateUniqueKey();
        storedData[keyToUse] = registro;
        saveToLocalStorage();
        renderTable();
        updateStatusChart();
        filterTable();

        if (!analysisResultsDiv.classList.contains('d-none') && itemAnaliseSelect.value === item) {
            gerarAnaliseComparativa();
        }

        limparFormulario();
        showToast(editMode ? "Registro atualizado com sucesso!" : "Registro inserido com sucesso!", false);
        editMode = false;
    }

    function limparFormulario() {
        formTitle.textContent="Inserir Novo Registro";
        editKeyInput.value="";
        [...document.querySelectorAll('.form-control, .form-select')].forEach(el => {
            if (el.id === 'referenceMonthInput') {
                 el.value = getCurrentRefMonth();
            } else if (el.type === 'number') {
                el.value = '';
            } else {
                el.value = "";
            }
            el.classList.remove('is-invalid');
        });
        btnCancelarEdicao.classList.add("d-none");
        editMode = false;
        const collapseEl = document.getElementById('collapseOne');
        const bsCollapse = bootstrap.Collapse.getInstance(collapseEl);
        if (bsCollapse) {
             bsCollapse.hide();
        }
    }

    function cancelarEdicao() {
        limparFormulario();
        showToast("Edição cancelada.");
    }

    function entrarEdicao(key) {
        if (!storedData[key]) return;
        const reg = storedData[key];
        formTitle.textContent = `Editar Registro (${reg.item} - ${formatYearMonth(reg.referenceMonth)})`;
        editMode = true;
        editKeyInput.value = key;
        dataRegistroInput.value = reg.dataRegistro;
        referenceMonthInput.value = reg.referenceMonth;
        itemSelect.value = reg.item;
        percRealizadoInput.value = reg.percRealizado != null ? reg.percRealizado.toFixed(3) : "";
        toneladaAbatidaInput.value = reg.toneladaAbatida != null ? reg.toneladaAbatida : "";
        origemInput.value = reg.origem;
        setorInput.value = reg.setor;
        acaoInput.value = reg.acao;
        dataPrevistaInput.value = reg.dataPrevista;
        dataRealizadaInput.value = reg.dataRealizada;
        areaResponsavelInput.value = reg.areaResp;
        responsavelNomeInput.value = reg.respNome;

        btnCancelarEdicao.classList.remove("d-none");
        const collapseEl = document.getElementById('collapseOne');
        const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseEl);
        if (reg.acao || reg.dataPrevista || reg.dataRealizada || reg.areaResp || reg.respNome) {
            bsCollapse.show();
        } else {
            bsCollapse.hide();
        }
        const entryTab = new bootstrap.Tab(document.getElementById('entry-tab'));
        entryTab.show();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        showToast("Modo de edição ativo. Modifique e clique em 'Salvar / Atualizar'.", false, 3000);
    }

    function excluirRegistro(key) {
        const reg = storedData[key];
        if (!reg) return;
        if (!confirm(`Tem certeza que deseja excluir o registro do item "${reg.item}" referente a ${formatYearMonth(reg.referenceMonth)}? Esta ação não pode ser desfeita diretamente (use o botão Desfazer se mudar de ideia imediatamente).`)) {
            return;
        }
        savePreviousState();
        const itemExcluido = reg.item;
        delete storedData[key];
        saveToLocalStorage();
        renderTable();
        updateStatusChart();
        filterTable();
        if (!analysisResultsDiv.classList.contains('d-none') && itemAnaliseSelect.value === itemExcluido) {
            gerarAnaliseComparativa();
        }
        showToast("Registro excluído com sucesso.");
    }

    function undoLastAction() {
        if (previousStoredDataState === null) {
            showToast("Nada para desfazer.", true);
            return;
        }
        storedData = deepCopy(previousStoredDataState);
        previousStoredDataState = null;
        saveToLocalStorage();
        renderTable();
        updateStatusChart();
        filterTable();
        if (!analysisResultsDiv.classList.contains('d-none') && itemAnaliseSelect.value) {
            gerarAnaliseComparativa();
        }
        btnUndo.disabled = true;
        showToast("Última ação desfeita.");
        limparFormulario();
    }

    /***********************************************************
     * RENDERIZAÇÃO TABELA E FILTROS (Layout atualizado)
     ***********************************************************/
    function renderTable() {
        tabelaAcoesBody.innerHTML = "";
        const entries = Object.entries(storedData);
        entries.sort(([,a], [,b]) => {
            const dateA = a.referenceMonth || a.dataRegistro || '0';
            const dateB = b.referenceMonth || b.dataRegistro || '0';
            return dateB.localeCompare(dateA);
        });
        if(entries.length === 0) {
            tabelaAcoesBody.innerHTML = `<tr><td colspan="15" class="text-center p-5 fst-italic text-muted">Nenhum registro encontrado. Comece adicionando um novo registro na aba 'Entrada/Edição'.</td></tr>`;
            return;
        }
        entries.forEach(([key, reg]) => {
            const tr = document.createElement("tr");
            tr.dataset.monthRef = formatYearMonth(reg.referenceMonth);
            tr.dataset.item = reg.item || '';
            tr.dataset.status = reg.statusAcao || 'Pendente';
            const percDisplay = reg.percRealizado != null ? reg.percRealizado.toFixed(3) + '%' : '---';
            const deficitDisplay = formatDeficitForTable(reg.deficitKg);
            const boxesDisplay = formatBoxesForTable(reg.missingBoxes);
            const dataRegDisplay = formatDate(reg.dataRegistro);
            const mesRefDisplay = formatYearMonth(reg.referenceMonth);
            const dataPrevDisplay = formatDate(reg.dataPrevista);
            const dataRealDisplay = formatDate(reg.dataRealizada);
            const statusDisplay = formatStatus(reg.statusAcao);
            tr.innerHTML = `
                <td class="text-center">${dataRegDisplay}</td>
                <td class="text-center">${mesRefDisplay}</td>
                <td>${reg.item || 'N/A'}</td>
                <td class="text-end">${percDisplay}</td>
                <td class="text-end">${deficitDisplay}</td>
                <td class="text-end">${boxesDisplay}</td>
                <td>${reg.origem || '---'}</td>
                <td>${reg.setor || '---'}</td>
                <td style="white-space: normal; max-width: 250px;">${reg.acao || '---'}</td>
                <td class="text-center">${dataPrevDisplay}</td>
                <td class="text-center">${dataRealDisplay}</td>
                <td class="text-center">${statusDisplay}</td>
                <td>${reg.areaResp || '---'}</td>
                <td>${reg.respNome || '---'}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-primary btn-action-icon btn-edit" data-key="${key}" title="Editar Registro" data-bs-toggle="tooltip" data-bs-placement="top">
                        <i class="fas fa-pencil-alt fa-xs"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-action-icon btn-delete" data-key="${key}" title="Excluir Registro" data-bs-toggle="tooltip" data-bs-placement="top">
                        <i class="fas fa-trash-alt fa-xs"></i>
                    </button>
                </td>`;
            tabelaAcoesBody.appendChild(tr);
        });
        tabelaAcoesBody.querySelectorAll('.btn-edit').forEach(button => {
            button.addEventListener('click', () => entrarEdicao(button.dataset.key));
        });
        tabelaAcoesBody.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', () => excluirRegistro(button.dataset.key));
        });
        const tooltipTriggerList = tabelaAcoesBody.querySelectorAll('[data-bs-toggle="tooltip"]');
        [...tooltipTriggerList].forEach(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
     }

    function filterTable() {
         const filterMonthValue = filterMonthInput.value.trim().toLowerCase();
         const filterItemValue = filterItemInput.value.trim().toLowerCase();
         const filterStatusValue = filterStatusSelect.value.toLowerCase();
         let visibleRowCount = 0;
         const tableRows = tabelaAcoesBody.querySelectorAll('tr');
         const noResultsRow = tabelaAcoesBody.querySelector('.no-results-row');
         if (noResultsRow) { noResultsRow.remove(); }
         tableRows.forEach(row => {
             if (row.cells.length < 15) return;
             const monthRefText = row.dataset.monthRef?.toLowerCase() || '';
             const itemText = row.dataset.item?.toLowerCase() || '';
             const statusText = row.dataset.status?.toLowerCase() || '';
             const monthMatch = filterMonthValue === '' || monthRefText.includes(filterMonthValue);
             const itemMatch = filterItemValue === '' || itemText.includes(filterItemValue);
             const statusMatch = filterStatusValue === '' || statusText === filterStatusValue;
             if (monthMatch && itemMatch && statusMatch) {
                 row.style.display = '';
                 visibleRowCount++;
             } else {
                 row.style.display = 'none';
             }
         });
         if (visibleRowCount === 0 && tableRows.length > 0 && !tabelaAcoesBody.querySelector('td[colspan="15"]')) {
             const tr = document.createElement('tr');
             tr.classList.add('no-results-row');
             tr.innerHTML = `<td colspan="15" class="text-center p-3 fst-italic text-muted">Nenhum registro corresponde aos filtros aplicados.</td>`;
             tabelaAcoesBody.appendChild(tr);
         }
    }

    function clearFilters() {
        filterMonthInput.value = '';
        filterItemInput.value = '';
        filterStatusSelect.value = '';
        filterTable();
        showToast("Filtros limpos.", false, 2000);
    }

    /***********************************************************
     * GRÁFICOS (lógica mantida)
     ***********************************************************/
    function updateStatusChart() {
        let counts = { Realizado: 0, Pendente: 0, 'Não Realizado': 0 };
        Object.values(storedData).forEach(registro => {
            let status = registro.statusAcao || "Pendente";
            if (counts.hasOwnProperty(status)) {
                counts[status]++;
            } else {
                 counts['Pendente']++;
            }
        });
        const ctx = document.getElementById("statusPieChart")?.getContext("2d");
        if (!ctx) {
            console.warn("Canvas do gráfico de status não encontrado.");
            return;
        }
        if (statusPieChart) {
            statusPieChart.destroy();
        }
        const total = counts.Realizado + counts.Pendente + counts['Não Realizado'];
        if (total === 0) {
             ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
             ctx.font = "10px Arial";
             ctx.fillStyle = "#6c757d";
             ctx.textAlign = "center";
             ctx.fillText("Sem dados de status", ctx.canvas.width / 2, ctx.canvas.height / 2);
             return;
        }
        statusPieChart = new Chart(ctx, {
            type: "pie",
            data: {
                labels: ["Realizado", "Pendente", "Não Realizado"],
                datasets: [{
                    data: [counts.Realizado, counts.Pendente, counts['Não Realizado']],
                    backgroundColor: ["#198754", "#ffc107", "#dc3545"],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: "bottom",
                        labels: {
                            boxWidth: 10,
                            padding: 8,
                            font: {
                                size: 9
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                             label: function(context) {
                                let label = context.label || '';
                                let value = context.parsed || 0;
                                let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                return `${label}: ${value} (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderizarGraficoComparativo(item, monthlyData) {
        const labels = monthlyData.map(d => formatYearMonth(d.month));
        const dataPoints = monthlyData.map(d => d.avgPercent);
        const metaValue = metas[item];
        const ctx = comparativeChartCanvas?.getContext("2d");
        if (!ctx) {
             console.warn("Canvas do gráfico comparativo não encontrado.");
             return;
        }
        if (comparativeBarChart) {
            comparativeBarChart.destroy();
        }
        const backgroundColors = dataPoints.map(p => p >= (metaValue - 0.0001) ? 'rgba(25, 135, 84, 0.7)' : 'rgba(220, 53, 69, 0.7)');
        const borderColors = dataPoints.map(p => p >= (metaValue - 0.0001) ? '#198754' : '#dc3545');
        const chartDataConfig = {
            labels: labels,
            datasets: [{
                label: `% Realizado - ${item}`,
                data: dataPoints,
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 1,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }]
        };
        const chartOptionsConfig = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: '% Realizado'
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(3) + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mês de Referência'
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                         label: function(context) {
                            let label = context.dataset.label || '';
                            let value = context.parsed.y;
                            return `${label}: ${value.toFixed(3)}%`;
                        }
                    }
                },
                annotation: {
                    annotations: {}
                },
                title: {
                    display: true,
                    text: `Comparativo Mensal de Rendimento - ${item}`,
                    font: { size: 14, weight: '500' },
                    padding: { top: 5, bottom: 15 }
                }
            }
        };
        if (metaValue !== undefined && metaValue !== null) {
            chartOptionsConfig.plugins.annotation.annotations.line1 = {
                type: 'line',
                yMin: metaValue,
                yMax: metaValue,
                borderColor: '#007bff',
                borderWidth: 1.5,
                borderDash: [6, 6],
                label: {
                    content: `Meta (${metaValue.toFixed(3)}%)`,
                    display: true,
                    position: 'end',
                    backgroundColor: 'rgba(0, 123, 255, 0.8)',
                    color: '#fff',
                    font: { weight: 'bold', size: 9 },
                    padding: 3,
                    borderRadius: 3
                }
            };
        } else {
            delete chartOptionsConfig.plugins.annotation;
        }
        comparativeBarChart = new Chart(ctx, {
            type: 'bar',
            data: chartDataConfig,
            options: chartOptionsConfig
        });
    }

    function gerarAnaliseComparativa() {
        const selectedItem = itemAnaliseSelect.value;
        analiseStatusSpan.textContent = "";
        analysisResultsDiv.classList.add('d-none');
        btnExportarPDF.classList.add('d-none');
        if (!selectedItem) {
            showToast("Selecione um item na lista para gerar a análise.", true);
            return;
        }
        analiseStatusSpan.textContent = `Gerando análise para ${selectedItem}...`;
        const itemData = Object.values(storedData).filter(d =>
            d.item === selectedItem &&
            d.percRealizado !== null &&
            d.referenceMonth
        );
        if (itemData.length === 0) {
            showToast(`Não há dados de rendimento registrados para o item "${selectedItem}" com mês de referência.`, true);
            analiseStatusSpan.textContent = `Sem dados suficientes para ${selectedItem}.`;
            return;
        }
        const monthlyTotals = {};
        let totalPeriodDeficitKg = 0;
        let totalPeriodSlaughterKg = 0;
        itemData.forEach(d => {
            const monthKey = d.referenceMonth;
            if (!monthlyTotals[monthKey]) {
                monthlyTotals[monthKey] = {
                    sumPercent: 0,
                    count: 0,
                    sumDeficitKg: 0,
                    sumSlaughterKg: 0
                };
            }
            monthlyTotals[monthKey].sumPercent += d.percRealizado;
            monthlyTotals[monthKey].count++;
            if (d.deficitKg !== null && d.deficitKg > 0) {
                monthlyTotals[monthKey].sumDeficitKg += d.deficitKg;
                totalPeriodDeficitKg += d.deficitKg;
            }
             if (d.toneladaAbatida !== null && d.toneladaAbatida > 0) {
                 monthlyTotals[monthKey].sumSlaughterKg += d.toneladaAbatida;
                 totalPeriodSlaughterKg += d.toneladaAbatida;
            }
        });
        const monthlyAverages = Object.entries(monthlyTotals).map(([monthKey, totals]) => ({
            month: monthKey,
            avgPercent: totals.sumPercent / totals.count,
            totalDeficitMonth: totals.sumDeficitKg,
            totalSlaughterMonth: totals.sumSlaughterKg
        }));
        monthlyAverages.sort((a, b) => a.month.localeCompare(b.month));
        if (monthlyAverages.length === 0) {
            showToast("Erro ao processar e agrupar os dados mensais.", true);
            analiseStatusSpan.textContent = "Erro no processamento.";
            return;
        }
        const totalPeriodMissingBoxes = calcularMissingBoxes(selectedItem, totalPeriodDeficitKg);
        renderizarDetalhesComparativos(selectedItem, monthlyAverages, totalPeriodDeficitKg, totalPeriodMissingBoxes);
        renderizarGraficoComparativo(selectedItem, monthlyAverages);
        analysisResultsDiv.classList.remove("d-none");
        btnExportarPDF.classList.remove("d-none");
        analiseStatusSpan.textContent = "";
        showToast(`Análise comparativa para ${selectedItem} gerada com sucesso.`, false);
         setTimeout(() => {
            analysisResultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
         }, 100);
    }

    function renderizarDetalhesComparativos(item, monthlyData, totalDeficitKg, totalMissingBoxes) {
        const meta = metas[item];
        const metaExists = meta !== undefined && meta !== null;
        const floatTolerance = 0.00001;
        let html = `<h4 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Resumo Comparativo: ${item}</h4>`;
        let totalPercentSum = 0;
        let bestMonth = { month: '', value: -Infinity };
        let previousPercent = null;
        monthlyData.forEach(data => {
            const currentPercent = data.avgPercent;
            const formattedMonth = formatYearMonth(data.month);
            totalPercentSum += currentPercent;
            if (currentPercent > bestMonth.value) {
                bestMonth = { month: formattedMonth, value: currentPercent };
            }
            let comparisonHtml = '';
            if (previousPercent !== null) {
                const diff = currentPercent - previousPercent;
                const absDiffFormatted = Math.abs(diff).toFixed(3);
                if (diff > floatTolerance) {
                    comparisonHtml = ` <span class="text-success small fw-bold" title="Melhora de ${absDiffFormatted}% em relação ao mês anterior">(<i class="fas fa-arrow-up"></i>+${absDiffFormatted}%)</span>`;
                } else if (diff < -floatTolerance) {
                    comparisonHtml = ` <span class="text-danger small fw-bold" title="Queda de ${absDiffFormatted}% em relação ao mês anterior">(<i class="fas fa-arrow-down"></i>-${absDiffFormatted}%)</span>`;
                } else {
                    comparisonHtml = ' <span class="text-muted small" title="Rendimento estável em relação ao mês anterior">(=)</span>';
                }
            }
            let metaStatusHtml = '';
            if (metaExists) {
                const achievedMeta = currentPercent >= (meta - floatTolerance);
                const metaText = achievedMeta ? "Meta Atingida" : "Abaixo da Meta";
                const metaClass = achievedMeta ? "bg-meta-ok" : "bg-meta-nok";
                metaStatusHtml = `<span class="badge ${metaClass} rounded-pill ms-1">${metaText}</span>`;
            }
            let deficitMonthHtml = '';
            if (data.totalDeficitMonth > 0) {
                deficitMonthHtml = ` <span class="deficit-info text-warning-emphasis small" title="Déficit acumulado no mês">[D: ${data.totalDeficitMonth.toFixed(0)} kg]</span>`;
            }
            html += `<p class="mb-2 border-bottom pb-2">
                        <span class="detail-label">${formattedMonth}:</span> ${currentPercent.toFixed(3)}%
                        ${comparisonHtml}
                        ${metaStatusHtml}
                        ${deficitMonthHtml}
                     </p>`;
            previousPercent = currentPercent;
        });
        const averagePercent = totalPercentSum / monthlyData.length;
        let averageMetaStatusHtml = '';
        if (metaExists) {
            const achievedAverageMeta = averagePercent >= (meta - floatTolerance);
            const averageMetaText = achievedAverageMeta ? "Média Atingiu Meta" : "Média Abaixo Meta";
            const averageMetaClass = achievedAverageMeta ? "bg-meta-ok" : "bg-meta-nok";
            averageMetaStatusHtml = `<span class="badge ${averageMetaClass} rounded-pill ms-1">${averageMetaText}</span>`;
        }
        html += `<div class="mt-3 pt-3 border-top">`;
        html += `<p class="mb-1"><span class="detail-label">Melhor Mês Registrado:</span> ${bestMonth.month} (${bestMonth.value.toFixed(3)}%)</p>`;
        html += `<p class="mb-1"><span class="detail-label">Média do Período (${monthlyData.length} meses):</span> ${averagePercent.toFixed(3)}% ${averageMetaStatusHtml}</p>`;
        if (totalDeficitKg > 0) {
            html += `<p class="mb-1 mt-2"><span class="detail-label">Déficit Total Acumulado:</span> <strong class="text-danger">${totalDeficitKg.toFixed(0)} kg</strong></p>`;
            if (totalMissingBoxes !== null) {
                 html += `<p class="mb-1"><span class="detail-label">Caixas Não Produzidas (Est.):</span> <strong class="text-danger">${totalMissingBoxes.toFixed(1)} cx</strong></p>`;
            } else if (boxWeights[item] === undefined) {
                 html += `<p class="mb-1"><span class="detail-label text-muted small">Peso por caixa não definido para ${item}, cálculo de caixas não disponível.</span></p>`;
            }
        } else {
             html += `<p class="mb-1 mt-2"><span class="detail-label">Déficit Total Acumulado:</span> <span class="text-success">0 kg (Meta atingida ou superada em todos os meses com dados)</span></p>`;
        }
        if (metaExists) {
            html += `<p class="mt-2 pt-2 border-top"><small class="text-muted fst-italic">Meta de rendimento para ${item}: ${meta.toFixed(3)}%</small></p>`;
        } else {
             html += `<p class="mt-2 pt-2 border-top"><small class="text-muted fst-italic">Meta de rendimento não definida para ${item}.</small></p>`;
        }
        html += `</div>`;
        comparisonDetailsOutputDiv.innerHTML = html;
    }

    /***********************************************************
     * EXPORTAÇÕES (PDF com chamada autoTable corrigida, CSV mantido)
     ***********************************************************/
    async function exportarPDF() {
        const selectedItem = itemAnaliseSelect.value;
        if (!selectedItem || analysisResultsDiv.classList.contains('d-none')) {
            showToast("Gere uma análise comparativa primeiro antes de exportar.", true);
            return;
        }
        showToast("Iniciando geração do Relatório PDF...", false, 6000);
        btnExportarPDF.disabled = true;
        pdfStatusSpan.textContent = "Gerando PDF, por favor aguarde...";
        try {
            const { jsPDF } = window.jspdf;
            if (typeof jsPDF.API.autoTable !== 'function') {
                console.error("Erro: jsPDF.API.autoTable não é uma função.");
                throw new Error("Falha ao carregar o componente de tabela do PDF (jsPDF-AutoTable).");
            }
            const pdf = new jsPDF({
                orientation: 'landscape',
                unit: 'pt',
                format: 'a4'
            });
            const pageMargin = 40;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const contentWidth = pageWidth - 2 * pageMargin;
            let currentY = pageMargin;
            const todayFormatted = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            pdf.setFontSize(18);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(0, 86, 179);
            pdf.text(`Relatório de Análise de Rendimento - ${selectedItem}`, pageMargin, currentY);
            currentY += 15;
            pdf.setFontSize(10);
            pdf.setFont(undefined, 'normal');
            pdf.setTextColor(108, 117, 125);
            pdf.text(`Relatório gerado em: ${todayFormatted}`, pageMargin, currentY);
            currentY += 30;
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(0, 86, 179);
            pdf.text("Resumo da Análise Comparativa Mensal", pageMargin, currentY);
            currentY += 20;
            const detailsElement = document.getElementById('comparisonDetailsOutput');
            const chartElement = document.getElementById('comparativeBarChart');
            const detailsCanvas = await html2canvas(detailsElement, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
            const chartCanvas = await html2canvas(chartElement, { scale: 2, backgroundColor: '#ffffff', useCORS: true });
            const detailsImgData = detailsCanvas.toDataURL('image/png');
            const chartImgData = chartCanvas.toDataURL('image/png');
            const detailsImgProps = pdf.getImageProperties(detailsImgData);
            const chartImgProps = pdf.getImageProperties(chartImgData);
            const detailsWidth = contentWidth * 0.38;
            const chartWidth = contentWidth * 0.58;
            const gapWidth = contentWidth * 0.04;
            const detailsHeight = (detailsImgProps.height * detailsWidth) / detailsImgProps.width;
            const chartHeight = (chartImgProps.height * chartWidth) / chartImgProps.width;
            const sectionHeight = Math.max(detailsHeight, chartHeight);
            if (currentY + sectionHeight > pageHeight - pageMargin - 20) {
                pdf.addPage();
                currentY = pageMargin;
            }
            pdf.addImage(detailsImgData, 'PNG', pageMargin, currentY, detailsWidth, detailsHeight);
            pdf.addImage(chartImgData, 'PNG', pageMargin + detailsWidth + gapWidth, currentY, chartWidth, chartHeight);
            currentY += sectionHeight + 30;
            if (currentY + 50 > pageHeight - pageMargin) {
                pdf.addPage();
                currentY = pageMargin;
            }
            pdf.setFontSize(14);
            pdf.setFont(undefined, 'bold');
            pdf.setTextColor(0, 86, 179);
            pdf.text("Dados Detalhados e Plano de Ações (Visão Filtrada Atual)", pageMargin, currentY);
            currentY += 20;
            const tableHeaders = [["Data Reg.", "Mês Ref.", "Item", "Real.(%)", "Déf.(Kg)", "Cx Falt.", "Origem", "Setor", "Ação Corretiva", "Prev.", "Real.", "Status", "Área Resp.", "Responsável"]];
            const tableBody = [];
            let tableRowCount = 0;
            tabelaAcoesBody.querySelectorAll('tr').forEach(row => {
                if (row.style.display !== 'none' && !row.classList.contains('no-results-row') && row.cells.length >= 15) {
                    const key = row.querySelector('.btn-edit')?.dataset.key;
                    if (key && storedData[key]) {
                        const r = storedData[key];
                        tableBody.push([
                            formatDate(r.dataRegistro),
                            formatYearMonth(r.referenceMonth),
                            r.item || '',
                            r.percRealizado != null ? r.percRealizado.toFixed(3) : '--',
                            r.deficitKg != null ? r.deficitKg.toFixed(0) : '--',
                            r.missingBoxes != null ? r.missingBoxes.toFixed(1) : '--',
                            r.origem || '',
                            r.setor || '',
                            r.acao || '',
                            formatDate(r.dataPrevista),
                            formatDate(r.dataRealizada),
                            r.statusAcao || 'Pendente',
                            r.areaResp || '',
                            r.respNome || ''
                        ]);
                        tableRowCount++;
                    }
                }
            });
            if (tableRowCount > 0) {
                pdf.autoTable({
                    head: tableHeaders,
                    body: tableBody,
                    startY: currentY,
                    theme: 'grid',
                    styles: {
                        fontSize: 7,
                        cellPadding: 3,
                        valign: 'middle',
                        overflow: 'linebreak'
                    },
                    headStyles: {
                        fillColor: [33, 37, 41],
                        textColor: 255,
                        fontSize: 7,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { cellWidth: 48, halign: 'center' },
                        1: { cellWidth: 40, halign: 'center' },
                        2: { cellWidth: 65 },
                        3: { cellWidth: 40, halign: 'right' },
                        4: { cellWidth: 40, halign: 'right' },
                        5: { cellWidth: 40, halign: 'right' },
                        8: { cellWidth: 120 },
                        9: { cellWidth: 48, halign: 'center' },
                        10: { cellWidth: 48, halign: 'center' },
                        11: { cellWidth: 45, halign: 'center' },
                    },
                    margin: { left: pageMargin, right: pageMargin },
                    didDrawPage: (data) => {
                        pdf.setFontSize(8);
                        pdf.setTextColor(150);
                        pdf.text('Página ' + pdf.internal.getNumberOfPages(), pageWidth - pageMargin, pageHeight - 15, { align: 'right' });
                    }
                });
            } else {
                 pdf.setFontSize(10);
                 pdf.setTextColor(108, 117, 125);
                 pdf.text("Nenhum dado detalhado para exibir com os filtros atuais aplicados.", pageMargin, currentY);
            }
            const filename = `Relatorio_Rendimento_${selectedItem.replace(/\W+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            pdf.save(filename);
            showToast("Relatório PDF exportado com sucesso!", false);
            pdfStatusSpan.textContent = "";
        } catch (error) {
            console.error("Erro detalhado ao gerar PDF:", error);
            showToast(`Erro ao gerar PDF: ${error.message || 'Verifique o console para detalhes.'}`, true, 8000);
            pdfStatusSpan.textContent = "Erro ao gerar PDF.";
        } finally {
            btnExportarPDF.disabled = false;
        }
    }

    function exportCSV() {
        let csvContent = "";
        const headers = [
            "Data Registro", "Mes Referencia", "Item", "Realizado (%)", "Deficit (Kg)",
            "Caixas Faltantes", "Origem", "Setor", "Acao Corretiva", "Data Prevista",
            "Data Realizada", "Status Acao", "Area Responsavel", "Responsavel"
        ];
        csvContent += "\uFEFF";
        csvContent += headers.map(h => `"${h}"`).join(";") + "\n";
        let dataFound = false;
        tabelaAcoesBody.querySelectorAll('tr').forEach(row => {
            if (row.style.display !== 'none' && !row.classList.contains('no-results-row') && row.cells.length >= 15) {
                const key = row.querySelector('.btn-edit')?.dataset.key;
                if (key && storedData[key]) {
                    const r = storedData[key];
                    dataFound = true;
                    const rowData = [
                        formatDate(r.dataRegistro),
                        formatYearMonth(r.referenceMonth),
                        r.item || '',
                        r.percRealizado != null ? r.percRealizado.toFixed(3).replace('.', ',') : '',
                        r.deficitKg != null ? r.deficitKg.toFixed(0) : '',
                        r.missingBoxes != null ? r.missingBoxes.toFixed(1).replace('.', ',') : '',
                        r.origem || '',
                        r.setor || '',
                        r.acao || '',
                        formatDate(r.dataPrevista),
                        formatDate(r.dataRealizada),
                        r.statusAcao || 'Pendente',
                        r.areaResp || '',
                        r.respNome || ''
                    ];
                    const csvRow = rowData.map(value => `"${(value || '').toString().replace(/"/g, '""')}"`).join(";");
                    csvContent += csvRow + "\n";
                }
            }
        });
        if (!dataFound) {
            showToast("Nenhum dado visível na tabela para exportar (verifique os filtros).", true);
            return;
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        const filename = `Dados_SIGRA_${new Date().toISOString().slice(0, 10)}.csv`;
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        showToast("Dados exportados para CSV com sucesso!", false);
    }

    /***********************************************************
     * NOVO: EXPORTAÇÃO/IMPORTAÇÃO JSON
     ***********************************************************/
    function exportJSON() {
        try {
            const jsonData = JSON.stringify(storedData, null, 4);
            const blob = new Blob([jsonData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const filename = `sigra_export_${new Date().toISOString().slice(0, 10)}.json`;
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showToast("Dados exportados para JSON com sucesso!", false);
        } catch(e) {
          console.error("Erro ao exportar JSON", e);
          showToast("Erro ao exportar JSON.", true);
        }
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) { return; }
        const reader = new FileReader();
        reader.onload = function(evt) {
            try {
                const jsonData = evt.target.result;
                const data = JSON.parse(jsonData);
                if (typeof data === "object") {
                    storedData = data;
                    saveToLocalStorage();
                    renderTable();
                    updateStatusChart();
                    filterTable();
                    showToast("Dados importados do JSON com sucesso!", false);
                } else {
                    throw new Error("Formato inválido");
                }
            } catch(e) {
                console.error("Erro ao importar JSON", e);
                showToast("Erro ao importar JSON.", true);
            }
            event.target.value = "";
        };
        reader.onerror = function(evt) {
            console.error("Erro de leitura", evt);
            showToast("Erro de leitura no arquivo JSON.", true);
        };
        reader.readAsText(file);
    }

    /***********************************************************
     * EVENT LISTENERS (mantido)
     ***********************************************************/
    function setupEventListeners() {
        btnSalvar.addEventListener("click", salvarDados);
        btnCancelarEdicao.addEventListener("click", cancelarEdicao);
        btnUndo.addEventListener("click", undoLastAction);
        btnGerarAnalise.addEventListener("click", gerarAnaliseComparativa);
        btnExportarPDF.addEventListener("click", exportarPDF);
        btnExportCSV.addEventListener("click", exportCSV);
        // NOVO: Listeners para JSON Export/Import
        btnExportJSON.addEventListener("click", exportJSON);
        btnImportJSON.addEventListener("click", () => { inputImportJson.click(); });
        inputImportJson.addEventListener("change", importJSON);
        itemAnaliseSelect.addEventListener('change', () => {
            analysisResultsDiv.classList.add('d-none');
            btnExportarPDF.classList.add('d-none');
            analiseStatusSpan.textContent = '';
            pdfStatusSpan.textContent = '';
            if (comparativeBarChart) {
                comparativeBarChart.destroy();
                comparativeBarChart = null;
                const ctx = comparativeChartCanvas?.getContext("2d");
                if(ctx) ctx.clearRect(0,0, comparativeChartCanvas.width, comparativeChartCanvas.height);
            }
        });
        filterMonthInput.addEventListener('input', filterTable);
        filterItemInput.addEventListener('input', filterTable);
        filterStatusSelect.addEventListener('change', filterTable);
        btnClearFilters.addEventListener('click', clearFilters);
    }
    //]]>
    </script>

</body>
</html>